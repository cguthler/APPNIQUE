<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecci√≥n 1 - Fundamentos</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #1b263b;
            color: #ffff00;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 { color: #00ff00; text-align: center; }
        .contenido { background: #415a77; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .btn {
            background: #28a745;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .btn:hover { background: #218838; }
        #testArea { margin-top: 20px; }
        .pregunta { margin: 15px 0; padding: 15px; background: #2a3f5f; border-radius: 8px; }
        .opcion { margin: 8px 0; }
        .opcion label { color: #fff; cursor: pointer; }
        .timer-bar { background: #333; height: 4px; margin-bottom: 10px; border-radius: 2px; }
        .timer-fill { background: #00ff00; height: 100%; width: 100%; transition: width 1s linear; }
        #resultArea { margin-top: 20px; }
    </style>
</head>
<body>

    <h1>üìö Lecci√≥n 1: Fundamentos y Reglas</h1>

    <!-- CONTENIDO DE LA LECCI√ìN -->
    <div class="contenido" id="contenidoLeccion">
        <h2>Contenido te√≥rico</h2>
        <p>Bienvenido a la primera lecci√≥n. Aqu√≠ aprender√°s los fundamentos b√°sicos del f√∫tbol:</p>
        <ul>
            <li><strong>Regla 1:</strong> Solo el portero puede usar las manos dentro del √°rea.</li>
            <li><strong>Regla 2:</strong> El offside se sanciona cuando un jugador est√° m√°s cerca del arco rival que el √∫ltimo defensor al recibir el pase.</li>
            <li><strong>Regla 3:</strong> El saque de banda se realiza con dos pies en el suelo y el bal√≥n detr√°s de la cabeza.</li>
            <li><strong>Regla 4:</strong> Los penales se cobran desde el punto penal a 11 metros del arco.</li>
        </ul>
        <p><strong>Tip:</strong> Controlar el bal√≥n con la planta o interior del pie te da mejor precisi√≥n.</p>
        
        <button class="btn" onclick="L1.iniciarTest()">Comenzar Test ‚Üí</button>
    </div>

    <!-- √ÅREA DEL TEST -->
    <div id="testArea"></div>
    <div id="resultArea"></div>

<script>
// NAMESPACE √∫nico para lecci√≥n 1
const L1 = {
    preguntas: [],
    idx: 0,
    aciertos: 0,
    timer: null,
    
    iniciarTest() {
        // Ocultar contenido, mostrar test
        document.getElementById('contenidoLeccion').style.display = 'none';
        this.idx = 0;
        this.aciertos = 0;
        this.preguntas = [
            {q: "¬øQui√©n puede usar las manos dentro del rect√°ngulo?", opts: ["Cualquier jugador", "Solo el portero", "El capit√°n", "Nadie"], ok: 1},
            {q: "¬øQu√© ocurre si est√°s m√°s cerca del arco que el √∫ltimo defensa al recibir un pase?", opts: ["Gol v√°lido", "Falta directa", "Offside", "Saque de meta"], ok: 2},
            {q: "¬øC√≥mo se debe realizar el saque de banda?", opts: ["Con un pie en la l√≠nea", "Saltando", "Dos pies en el campo y pelota detr√°s de la cabeza", "Con la mano"], ok: 2},
            {q: "¬øD√≥nde se cobra un penal?", opts: ["Desde el c√≠rculo central", "Desde el punto penal", "Desde la banda", "Desde el corner"], ok: 1},
            {q: "¬øCon qu√© parte del pie se recomienda controlar un bal√≥n alto?", opts: ["Empeine", "Planta o interior", "Tal√≥n", "Rodilla"], ok: 1},
            {q: "¬øA qu√© pie se le debe pasar la pelota al compa√±ero?", opts: ["Al pie malo", "Al que est√© m√°s cerca", "Al pie bueno", "Al que pida de tal√≥n"], ok: 2},
            {q: "¬øA qu√© poste se recomienda apuntar al disparar?", opts: ["Al que est√© m√°s lejos", "Al palo cercano", "Al √°rbitro", "Al cielo"], ok: 1},
            {q: "¬øC√≥mo se debe marcar al rival?", opts: ["Por detr√°s", "De frente", "De costado, brazo extendido, sin derribar", "Corriendo tras √©l"], ok: 2},
            {q: "¬øQu√© se debe hacer antes de pedir la pelota?", opts: ["Quedarse quieto", "Gritar m√°s fuerte", "Desmarcarse con dos pasos y se√±alar", "Esperar al √°rbitro"], ok: 2},
            {q: "¬øQu√© error evita el equipo que quiere mantener el orden?", opts: ["Salir por el centro del √°rea", "Pase largo", "Tiro al arco", "Corners"], ok: 0}
        ];
        this.mostrarPregunta();
    },
    
    mostrarPregunta() {
        const p = this.preguntas[this.idx];
        const total = this.preguntas.length;
        
        let html = `
            <div class="timer-bar"><div class="timer-fill" id="timerFill"></div></div>
            <div class="pregunta">
                <h3>Pregunta ${this.idx + 1} de ${total}</h3>
                <p style="color: #fff; font-size: 18px;">${p.q}</p>
                <div id="opciones">
        `;
        
        p.opts.forEach((opt, i) => {
            html += `
                <div class="opcion">
                    <input type="radio" name="respuesta" id="opt${i}" value="${i}" style="margin-right: 10px;">
                    <label for="opt${i}">${opt}</label>
                </div>
            `;
        });
        
        html += `
                </div>
                <button class="btn" style="margin-top: 15px;" onclick="L1.corregir()">Responder</button>
            </div>
        `;
        
        document.getElementById('testArea').innerHTML = html;
        
        // Timer de 15 segundos
        let tiempo = 15;
        const timerFill = document.getElementById('timerFill');
        this.timer = setInterval(() => {
            tiempo--;
            timerFill.style.width = (tiempo / 15 * 100) + '%';
            if (tiempo <= 0) {
                clearInterval(this.timer);
                this.corregir(true); // timeout
            }
        }, 1000);
    },
    
    corregir(timeout = false) {
        clearInterval(this.timer);
        
        const seleccion = document.querySelector('input[name="respuesta"]:checked');
        if (!seleccion && !timeout) {
            alert("Seleccion√° una opci√≥n");
            return;
        }
        
        const respuesta = seleccion ? parseInt(seleccion.value) : -1;
        if (respuesta === this.preguntas[this.idx].ok) {
            this.aciertos++;
        }
        
        this.idx++;
        
        if (this.idx < this.preguntas.length) {
            this.mostrarPregunta();
        } else {
            this.finalizar();
        }
    },
    
    async finalizar() {
        const total = this.preguntas.length;
        const testArea = document.getElementById('testArea');
        const resultArea = document.getElementById('resultArea');
        
        testArea.innerHTML = '';
        
        if (this.aciertos === total) {
            // ‚úÖ APROB√ì - OBTENER JUGADOR_ID DE LA URL
            const urlParams = new URLSearchParams(window.location.search);
            const jugadorId = urlParams.get('jugador_id');
            
            if (!jugadorId) {
                resultArea.innerHTML = `
                    <div style="background: #dc3545; color: white; padding: 20px; border-radius: 8px; text-align: center;">
                        <h3>‚ùå Error</h3>
                        <p>No se encontr√≥ el ID del jugador. Cerr√° y volv√© a ingresar tu c√©dula.</p>
                    </div>
                `;
                return;
            }
            
            // GUARDAR EN BASE DE DATOS
            try {
                const res = await fetch('/guardar_aprobacion_pg', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        jugador_id: parseInt(jugadorId),
                        leccion_numero: 1,
                        nota: this.aciertos
                    })
                });
                
                const data = await res.json();
                
                if (data.status === 'ok') {
                    // ‚úÖ MOSTRAR √âXITO Y BOT√ìN PARA AVANZAR
                    resultArea.innerHTML = `
                        <div style="background: #28a745; color: white; padding: 30px; border-radius: 10px; text-align: center;">
                            <h2>üéâ ¬°Felicitaciones!</h2>
                            <p style="font-size: 20px;">Aprobaste con ${this.aciertos}/${total}</p>
                            <p>Lecci√≥n 1 completada correctamente.</p>
                            <button class="btn" style="font-size: 18px; margin-top: 20px;" onclick="L1.siguienteLeccion()">
                                Continuar a Lecci√≥n 2 ‚Üí
                            </button>
                        </div>
                    `;
                } else {
                    throw new Error(data.msg || 'Error al guardar');
                }
            } catch (err) {
                resultArea.innerHTML = `
                    <div style="background: #ffc107; color: #000; padding: 20px; border-radius: 8px;">
                        <h3>‚ö†Ô∏è Error al guardar</h3>
                        <p>${err.message}</p>
                        <button class="btn" onclick="location.reload()">Reintentar</button>
                    </div>
                `;
            }
            
        } else {
            // ‚ùå NO APROB√ì
            resultArea.innerHTML = `
                <div style="background: #ffc107; color: #000; padding: 30px; border-radius: 10px; text-align: center;">
                    <h3>No aprobaste</h3>
                    <p style="font-size: 18px;">Obtuviste ${this.aciertos}/${total}</p>
                    <p>Necesit√°s 10/10 para aprobar.</p>
                    <button class="btn" style="background: #dc3545; margin-top: 15px;" onclick="location.reload()">
                        ‚Üª Reintentar Lecci√≥n
                    </button>
                </div>
            `;
        }
    },
    
    // ‚úÖ FUNCI√ìN CLAVE: AVANZAR A SIGUIENTE LECCI√ìN
    siguienteLeccion() {
        // Enviar mensaje al padre (app.py) para que abra la siguiente lecci√≥n
        if (window.parent !== window) {
            window.parent.postMessage({
                tipo: 'leccion_aprobada',
                leccion: 1,
                nota: 10
            }, '*');
        }
    }
};
</script>

</body>
</html>