<script>
// NAMESPACE único para lección 1
const L1 = {
  preguntas: [],
  idx: 0,
  aciertos: 0,
  timer: null,
  
  volver() { location.reload(); },
  
  corregir() {
    const sel = document.querySelector('input[name="opt"]:checked');
    if(!sel){ alert("Elegí una opción."); return; }
    clearInterval(L1.timer);
    if(parseInt(sel.value) === L1.preguntas[L1.idx].ok) L1.aciertos++;
    L1.idx++;
    if(L1.idx < L1.preguntas.length){ L1.mostrarPregunta(); } else { L1.finalizar(); }
  },
  
  async finalizar() {
    const total = L1.preguntas.length;
    if (L1.aciertos === total) {
      localStorage.setItem("modulo1", "aprobado");

      const jugadorId = window.jugadorIdReal;
      if (!jugadorId) {
        alert("No se encontró el id del jugador");
        return;
      }

      const payload = {
        jugador_id:     jugadorId,
        leccion_numero: 1,
        nota:           L1.aciertos
      };

      try {
        const res = await fetch("/guardar_aprobacion_pg", {
          method:  "POST",
          headers: {"Content-Type": "application/json"},
          body:    JSON.stringify(payload),
          credentials: "include"
        });

        if (!res.ok) throw new Error("Error HTTP " + res.status);

        const data = await res.json();
        if (data.status !== "ok") throw new Error(data.msg || "Falló guardar");

        // Todo bien → mostrar resultado
        document.getElementById('resultArea').innerHTML =
          `<div class="alert alert-success">¡Aprobaste! Estás listo para jugar tu partido.</div>`;

        const btnSiguiente = document.createElement('button');
        btnSiguiente.className = 'btn btn-success mt-3';
        btnSiguiente.textContent = 'Ver siguiente lección →';
        btnSiguiente.onclick = () => abrirLeccionDentro(2);
        document.getElementById('resultArea').appendChild(btnSiguiente);

      } catch (e) {
        console.error(e);
        alert("No se pudo guardar la nota: " + e.message);
      }

    } else {
      document.getElementById('resultArea').innerHTML =
        `<div class="alert alert-warning">Respondiste ${L1.aciertos}/${total}. Necesitas 10/10 para aprobar.</div>`;
      setTimeout(() => L1.volver(), 3000);
    }
  },
  
  iniciar() {
    L1.idx = 0;
    L1.aciertos = 0;
    L1.preguntas = [
      {q:"¿Quién puede usar las manos dentro del rectángulo?",opts:["Cualquier jugador","Solo el portero","El capitán","Nadie"],ok:1},
      {q:"¿Qué ocurre si estás más cerca del arco que el último defensa al recibir un pase?",opts:["Gol válido","Falta directa","Offside","Saque de meta"],ok:2},
      {q:"¿Cómo se debe realizar el saque de banda?",opts:["Con un pie en la línea","Saltando","Dos pies en el campo y pelota detrás de la cabeza","Con la mano"],ok:2},
      {q:"¿Dónde se cobra un penal?",opts:["Desde el círculo central","Desde el punto penal","Desde la banda","Desde el corner"],ok:1},
      {q:"¿Con qué parte del pie se recomienda controlar un balón alto?",opts:["Empeine","Planta o interior","Talón","Rodilla"],ok:1},
      {q:"¿A qué pie se le debe pasar la pelota al compañero?",opts:["Al pie malo","Al que esté más cerca","Al pie bueno","Al que pida de talón"],ok:2},
      {q:"¿A qué poste se recomienda apuntar al disparar?",opts:["Al que esté más lejos","Al palo cercano","Al árbitro","Al cielo"],ok:1},
      {q:"¿Cómo se debe marcar al rival?",opts:["Por detrás","De frente","De costado, brazo extendido, sin derribar","Corriendo tras él"],ok:2},
      {q:"¿Qué se debe hacer antes de pedir la pelota?",opts:["Quedarse quieto","Gritar más fuerte","Desmarcarse con dos pasos y señalar","Esperar al árbitro"],ok:2},
      {q:"¿Qué error evita el equipo que quiere mantener el orden?",opts:["Salir por el centro del área","Pase largo","Tiro al arco","Corners"],ok:0}
    ];
    L1.mostrarTest();
  },
  
  mostrarTest() {
    document.querySelector('.btn-success').style.display = 'none';
    L1.mostrarPregunta();
  },
  
  mostrarPregunta(){
    const p = L1.preguntas[L1.idx];
    let html = `<div class="timer-bar"><div class="timer-fill" style="width:100%"></div></div>
                <b>Pregunta ${L1.idx+1}/10</b> – ${p.q}<br><small id="countdown">12s</small><div class="mt-2">`;
    p.opts.forEach((o,k)=> html += `
      <div class="form-check">
        <input class="form-check-input" type="radio" name="opt" id="o${k}" value="${k}">
        <label class="form-check-label" for="o${k}" style="color:#fff">${o}</label>
      </div>`);
    html += `</div><button class="btn btn-primary btn-sm mt-2" onclick="L1.corregir()">Siguiente</button>`;
    document.getElementById('testArea').innerHTML = html;

    let seg = 12;
    const bar = document.querySelector('.timer-fill');
    const txt = document.getElementById('countdown');
    L1.timer = setInterval(()=>{
      seg--;
      bar.style.width = (seg/12*100) + '%';
      txt.textContent = seg + 's';
      if(seg === 0){ clearInterval(L1.timer); L1.timeOut(); }
    },1000);
  },
  
  timeOut(){ 
    alert("Se acabó el tiempo. Volvé a intentarlo."); 
    L1.volver(); 
  }
};

// Función global que llama el HTML
function mostrarTest() { L1.iniciar(); }
</script>